# Dota 2 沙盘系统规划

> [!IMPORTANT]
> **当前聚焦**：眼位模拟器（M1 + M4），详见 [ward-simulator-plan.md](./ward-simulator-plan.md)
> 
> 本文档为完整远期规划，暂缓执行。

## 愿景

构建一个 **Dota 2 战术沙盘**，融合 **模拟** 与 **复盘** 两大核心能力：

1. **模拟模式**：在地图上放置单位，规划行动路线，模拟战局发展
2. **复盘模式**：解析并播放 Dota 2 录像（.dem 文件），可视化比赛过程
3. **沙盘推演**：在复盘过程中暂停，切换到模拟模式，探索"如果当时这样做会怎样"

---

## 里程碑规划

### M0 - 基础设施 ✅ 已完成
> 地图渲染与基础交互

- [x] 地图底图（地势图 + 导航网格）
- [x] 滚轮缩放 + 中键拖拽
- [x] 实体渲染（树木/野怪营地/建筑/塔/神符）
- [x] A* 寻路算法
- [x] 砍树功能（动态障碍物）
- [x] 实体数据结构化（`entities/` 目录）

---

### M1 - 实体信息层 ✅ 已完成
> 点击查看详情，为后续模拟提供数据基础

**已完成功能**：
- [x] 点击实体显示详情浮窗（野怪/塔/遗迹/前哨）
- [x] 野怪营地类型标注（小/中/大/远古）
- [x] 图标雪碧图渲染（36个图标 + 颜色叠加）
- [x] 寻路算法优化（二叉堆 + 降采样）

**数据文件**：
- `neutral-camp-types.json`：28 个营地类型
- `icons-config.json`：36 个图标配置
- `neutrals.json`：野怪属性
- `buildings.json`：建筑属性

---

### M2 - 时间轴系统 🎯 核心
> 引入时间维度，地图状态随时间变化

**功能清单**：
- [ ] 时间轴控制器（0:00 ~ 60:00）
- [ ] 野怪刷新状态（60 秒周期）
- [ ] 神符/赏金符/经验神龛刷新状态
- [ ] 肉山/痛苦魔方状态
- [ ] 兵线位置计算（简化模型）
- [ ] 日夜循环显示

**技术要点**：
- 状态管理：`gameTime` 驱动所有时间相关状态
- 兵线模型：基于移速和路径长度的近似计算

---

### M3 - 单位系统 ⭐ 可选
> 在地图上放置可控单位（简化版：仅放置英雄图标 + 显示属性）

**功能清单**：
- [ ] 放置英雄（选择英雄、设置等级/装备）
- [ ] 单位属性面板（移速/攻击/血量等）
- [ ] 单位移动命令（点击设置目标点）
- [ ] 移动时间实时计算
- [ ] 多单位管理

**数据需求**：
- 英雄基础属性数据
- 物品对属性的加成

---

### M4 - 视野与战争迷雾 ⭐ 可选
> 模拟视野系统（简化版：仅显示视野圈，不需要完整战争迷雾）

**功能清单**：
- [ ] 基础圆形视野（白天 1800 / 夜间 800）
- [ ] 高地视野遮挡（低地看不到高地）
- [ ] 树木视野遮挡
- [ ] 眼位系统（放置/移除真假眼）
- [ ] 战争迷雾渲染（阵营视角切换）
- [ ] 建筑/单位视野叠加

**技术要点**：
- 视野计算：射线投射 / 预计算视野图
- 迷雾渲染：Canvas 遮罩层 / WebGL（性能更优）
- 依赖 M2（日夜周期）和 M3（单位位置）

**数据需求**：
- 高度地图数据（已有 `elevation.png`）
- 视野遮挡物位置（树木、建筑）

---

### M5 - 行动规划 🔮 远期
> 为单位规划一系列有序行动

**功能清单**：
- [ ] 行动队列（移动 → 攻击 → 施法）
- [ ] 时间轴上显示行动规划
- [ ] 行动预估（到达时间、完成时间）
- [ ] 多单位行动协调

**技术要点**：
- 行动抽象：`Action { type, target, duration }`
- 优先级和中断机制

---

### M6 - 录像解析 🔮 远期
> 解析 Dota 2 .dem 录像文件

**功能清单**：
- [ ] .dem 文件解析（Source 2 Protobuf）
- [ ] 提取关键数据：
  - 单位位置（tick by tick）
  - 技能释放事件
  - 击杀/死亡事件
  - 物品购买
- [ ] 录像时间轴控制（播放/暂停/跳转）

**技术挑战**：
- .dem 格式复杂，可考虑使用现有库（[clarity-js](https://github.com/skadistats/clarity)）
- 数据量大，需要流式处理或预处理

---

### M7 - 录像播放器 🔮 远期
> 在沙盘上重现录像内容

**功能清单**：
- [ ] 单位位置同步显示
- [ ] 技能特效可视化（简化）
- [ ] 事件标记（击杀/推塔/Roshan）
- [ ] 播放速度控制

---

### M8 - 沙盘推演（远期愿景）
> 录像暂停后进入模拟模式

**功能清单**：
- [ ] 从录像快照创建沙盘状态
- [ ] 用户规划单位行动
- [ ] 未规划单位的 AI 行为：
  - 简单：保持静止/继续当前行为
  - 中级：基于规则的决策（攻击最近目标等）
  - 高级：学习型 AI（极难实现）
- [ ] 推演结果对比

**技术挑战**：
- 战斗模拟准确性
- AI 行为合理性
- 可能需要简化，如"粗粒度模拟"

---

## 技术架构演进

```
M0-M2: 静态展示 + 时间轴
       └── 数据: JSON 文件
       └── 渲染: Canvas 2D

M3-M5: 单位系统 + 视野 + 行动规划
       └── 状态管理: 需引入更强的状态管理
       └── 考虑: Pinia / 自定义状态机
       └── 视野渲染: 可能需要 WebGL

M6-M7: 录像解析 + 播放
       └── 可能需要: WebAssembly（性能）
       └── 可能需要: Worker（后台解析）

M8:    沙盘推演
       └── 战斗模拟引擎
       └── AI 决策系统
```

---

## 风险与备选方案

| 风险 | 影响 | 备选方案 |
|------|------|----------|
| 视野计算性能差 | M4 卡顿 | 降低精度 / 使用 WebGL |
| .dem 解析过于复杂 | M6-M8 无法实现 | 改用第三方服务预处理 |
| 战斗模拟不准确 | M8 体验差 | 简化为"路径模拟"，不含战斗 |
| AI 行为不合理 | M8 缺乏真实感 | 只支持手动规划，无自动 AI |

---

## 当前优先级

1. ~~**M1 实体信息层**~~：✅ 已完成
2. **M2 时间轴系统**：🎯 下一目标
3. **M3 单位系统**：核心功能，模拟和复盘都依赖
4. **M4 视野系统**：战术分析的关键能力

> [!NOTE]
> M6-M8 风险较高，但 M1-M5 可以独立提供价值（战术沙盘工具）。
> 即使录像功能无法实现，M1-M5 本身也是完整可用的。
