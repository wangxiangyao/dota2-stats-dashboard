# 交互式地图功能增强计划

## 概述

在现有寻路功能基础上，增加树木、野怪营地、建筑等地图元素的显示和交互功能，打造一个功能完整的 Dota 2 交互式地图。

---

## 数据源

### dota-map-coordinates 项目 (mapdata.json)

| 实体类型 | 数量 | 数据字段 | 用途 |
|---------|------|----------|------|
| `ent_dota_tree` | 2456 | x, y, z | 树木位置显示 |
| `npc_dota_neutral_spawner` | 28 | x, y | 野怪刷新点 |
| `npc_dota_tower` | 22 | x, y, name, health, armor, damage | 防御塔 |
| `npc_dota_watch_tower` | 2 | x, y, name | 前哨 |
| `npc_dota_fort` | 2 | x, y | 遗迹 |
| `ent_dota_fountain` | 2 | x, y | 泉水 |

### dota2-analysis 项目 (已有)

| 文件 | 内容 |
|------|------|
| `neutrals.json` | 野怪详细属性（金钱、经验、血量等） |
| `buildings.json` | 建筑详细属性 |

---

## 实施计划

### ~~阶段一：数据准备~~ ✅ 已跳过

**决定**：直接使用 `dota-map-coordinates` 项目的 `mapdata.json`，不额外生成 `map-entities.json`。

**数据来源** (`mapdata.json`)：
- `npc_dota_neutral_spawner` - 28 个野怪刷新点
- `npc_dota_watch_tower` - 2 个前哨
- `ent_dota_fountain` - 2 个泉水
- `ent_dota_tree` - 2456 棵树木
- `npc_dota_tower` - 防御塔
- `npc_dota_fort` - 遗迹

---

### 阶段二：地图图层显示

#### 2.1 树木层
- [ ] 绿色小圆点显示树木位置
- [ ] 优化渲染性能（2456 棵树需要考虑性能）
- [ ] 可选：根据高度 z 值调整颜色深浅

#### 2.2 野怪营地层
- [x] 显示 28 个野怪刷新点（橙色小圆点）
- [x] **数据拆分完成**：`mapdata.json` 已拆分为独立实体文件（`scripts/split-mapdata.cjs`）
  - 实体数据：`public/data/world/entities/`
  - 自定义数据模板：`public/data/world/custom/neutral-camp-types.json`
- [ ] **手动编辑营地类型**：为 28 个营地标注类型（small/medium/large/ancient）
- [ ] 不同营地类型使用不同颜色/大小：
  - 小野：绿色小圆点
  - 中野：黄色中圆点
  - 大野：橙色大圆点
  - 远古：紫色最大圆点
- [ ] 显示营地范围圈（刷新范围）

#### 2.3 建筑层
- [x] 前哨：六边形紫色图标
- [x] 泉水：圆形带⛲图标
- [x] 遗迹：菱形金色图标
- [ ] 防御塔：按阵营着色（天辉绿/夜魇红），按等级区分大小

---

### 阶段三：图层控制

#### 3.1 图层开关面板
- [ ] 添加图层控制 UI
- [ ] 可独立开关的图层：
  - [x] 导航网格（已有，调试用）
  - [ ] 树木
  - [ ] 野怪营地
  - [ ] 防御塔
  - [ ] 其他建筑（遗迹/前哨/泉水）
  - [ ] 寻路路径
- [ ] 图层状态持久化（localStorage）

---

### 阶段四：交互功能

#### 4.1 野怪营地详情
- [ ] 点击营地显示弹窗/面板
- [ ] 显示内容：
  - 营地类型
  - 可能刷新的野怪组合
  - 总金钱范围
  - 总经验值
  - 刷新时间
- [ ] 关联 `neutrals.json` 数据

#### 4.2 防御塔详情
- [ ] 点击塔显示属性
- [ ] 显示内容：
  - 塔等级 (T1/T2/T3/T4)
  - 血量、护甲
  - 攻击力、攻击速度
  - 赏金
- [ ] 关联 `buildings.json` 数据

#### 4.3 通用交互
- [ ] 鼠标悬停高亮
- [ ] 点击选中效果
- [ ] ESC 或点击空白处取消选中

---

### 阶段五：动态障碍物与寻路

#### 5.1 树木对寻路的影响
- [ ] 点击树木可"砍伐"（临时移除）
- [ ] 砍伐后动态更新导航数据
- [ ] 重新计算路径，展示砍树前后的路径差异
- [ ] "重置所有树木"按钮恢复原状
- [ ] 应用场景：分析砍树走位、Timber 砍树路线等

#### 5.2 建筑物对寻路的影响
- [ ] 建筑物（塔、遗迹等）默认阻挡通行
- [ ] 点击建筑可"摧毁"（临时移除阻挡）
- [ ] 展示建筑存在/摧毁时的路径差异
- [ ] 应用场景：分析推塔后的 gank 路线变化

#### 5.3 障碍物管理
- [ ] 显示当前"已砍伐的树"列表
- [ ] 显示当前"已摧毁的建筑"列表
- [ ] 支持单独恢复某个障碍物
- [ ] 支持一键重置所有状态

---

### 阶段六：刷野路线规划

#### 6.1 多点路线计算
- [ ] 支持选择多个野怪营地
- [ ] 计算最优访问顺序（旅行商问题简化版）
- [ ] 显示总路线和预计时间

#### 6.2 刷野效率分析
- [ ] 计算每分钟理论最大收益
- [ ] 考虑野怪刷新时间（60秒）
- [ ] 显示推荐刷野路线

---

## 技术要点

### 性能优化
- 树木渲染：使用离屏 Canvas 预渲染，避免每帧重绘 2456 个点
- 图层缓存：每个图层单独 Canvas，合成显示
- 视口裁剪：只渲染可见区域（如果支持缩放）

### 坐标系统
- 所有坐标转换使用现有的 `worldToCanvas` 函数
- 确保与 gridnav.png 坐标系一致

### 数据加载
- 按需加载：只在开启图层时加载对应数据
- 缓存数据：避免重复请求

### 动态导航数据
- **基础导航**：gridnav.png 提供静态可行走区域
- **树木阻挡**：
  - 每棵树占据一个或多个网格点
  - 维护 `removedTrees: Set<string>` 记录已砍伐的树
  - `isWalkable()` 函数检查：基础可行走 OR 该位置的树已被砍伐
- **建筑阻挡**：
  - 建筑占据多个网格点（根据 bounds 计算）
  - 维护 `destroyedBuildings: Set<string>` 记录已摧毁建筑
  - 建筑摧毁后，其占据的网格变为可行走
- **路径重算**：
  - 障碍物状态变化后自动重新寻路
  - 显示路径变化对比（可选）

---

## 文件结构

```
components/world/
├── MapMoveSpeed.vue          # 主地图组件（现有）
├── layers/
│   ├── TreeLayer.vue         # 树木图层
│   ├── NeutralCampLayer.vue  # 野怪营地图层
│   ├── BuildingLayer.vue     # 建筑图层
│   └── PathLayer.vue         # 路径图层
├── panels/
│   ├── LayerControl.vue      # 图层控制面板
│   ├── CampDetail.vue        # 营地详情面板
│   └── TowerDetail.vue       # 防御塔详情面板
└── composables/
    ├── useMapLayers.ts       # 图层管理逻辑
    └── useMapInteraction.ts  # 交互逻辑

public/data/world/
├── map-entities.json         # 地图实体坐标（新增）
├── neutrals.json             # 野怪属性（已有）
├── buildings.json            # 建筑属性（已有）
└── map/
    ├── gridnav.png           # 导航数据（已有）
    └── elevation.png         # 高度图/底图（已有）
```

---

## 预期效果

1. **基础地图**：显示地形 + 可行走区域
2. **完整地图**：叠加树木、野怪点、建筑
3. **交互地图**：点击查看详情、规划路线
4. **实用工具**：刷野路线规划、移动时间计算

---

## 待解决问题

### ~~问题1：导航图可行走区域需要透明化~~ ✅ 已解决

**现状**：gridnav.png 是 RGB 格式，白色背景不透明
**需求**：叠加到高度图上时，只显示障碍（黑色），可行走区域透明

**解决方案**：
- [x] 在前端加载后处理：白色像素 → 透明
- [x] 叠加显示时已实现透明化处理

---

### ~~问题2：桥梁未被识别为可行走区域~~ ✅ 已解决

**现状**：新版本 Dota 2 添加了两座桥梁，导航数据中显示为不可行走

**解决方案（已实施）**：
- [x] 使用**多高度层检测策略**：在 `IsTraversable` 检测时测试多个高度 (0, 64, 128, 192)
- [x] 桥梁在高层（约 128）返回可通行，问题解决
- [x] 相关代码：`addon_game_mode.lua` 的 `TestGridNav` 函数

**桥梁位置**：
- 桥梁1（上路河道）：x: 2000~2900, y: 640
- 桥梁2（下路河道）：x: -2900~-2000, y: -750

---

### ~~问题3：地势图缺少斜坡可视化~~ ✅ 已解决

**现状**：地势图 (elevation.png) 只显示高度灰度，无法直观看出哪些地方可以上下坡

**解决方案（已实施）**：
- [x] 在 `generate_images.py` 中添加斜坡检测功能
- [x] 检测相邻格子高度不同且**双方都可通行**的区域（即可走的斜坡）
- [x] 用**棕色/土色**标记斜坡区域，与灰色地形形成区分
- [x] 不再需要 minimap 图片，直接使用生成的地势图作为地图背景

---

### 问题4：大数据量输出限制

**现状**：
- Dota 2 VScript 的 `StringToFile` API 不可用
- 大量数据通过 `print()` 输出到控制台时受限

**解决方案（已实施）**：
- [x] 使用**位图格式**输出 gridnav 数据（每行一串 0/1 字符）
- [x] 使用**网格格式**输出 elevation 数据（每行逗号分隔的数值）
- [x] Python 端解析新格式并转换为 JSON

---

## 里程碑

- [x] **M0 - 数据修复**：导航图透明化 + 桥梁识别 + 斜坡可视化 ✅
- [x] **M1 - 数据准备**：直接使用 mapdata.json ✅ 已跳过
- [ ] **M2 - 静态显示**：树木 + 野怪营地 + 建筑显示 ⬅️ 当前
- [ ] **M3 - 图层控制**：可切换显示各图层
- [ ] **M4 - 交互详情**：点击显示营地/塔详情
- [ ] **M5 - 动态障碍物**：砍树/摧毁建筑影响寻路
- [ ] **M6 - 路线规划**：多点刷野路线计算

