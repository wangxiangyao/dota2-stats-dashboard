# Dota 2 沙盘系统规划

> 远期愿景：构建一个融合模拟、复盘、推演的 Dota 2 战术沙盘

---

## 愿景

构建一个 **Dota 2 战术沙盘**，融合三大核心能力：

1. **模拟模式**：在地图上放置单位，规划行动路线，模拟战局发展
2. **复盘模式**：解析并播放 Dota 2 录像（.dem 文件），可视化比赛过程
3. **沙盘推演**：在复盘过程中暂停，切换到模拟模式，探索"如果当时这样做会怎样"

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Applications)                     │
│  ┌─────────────┬──────────────┬───────────────────────────┐ │
│  │ 刷野模拟器  │  沙盘推演    │  录像复盘                 │ │
│  └─────────────┴──────────────┴───────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    行动系统 (Action System)                  │
│  Move / Attack / Cast / Chop / Stack / Pull / ...           │
├─────────────────────────────────────────────────────────────┤
│                    路径规划 (Path Planning)                  │
│  Multi-waypoint / Multi-path / Timeline-aware               │
├─────────────────────────────────────────────────────────────┤
│                    单位系统 (Unit System)                    │
│  Hero / Creep / Tower / Neutral / Roshan / Tormentor / ...  │
├─────────────────────────────────────────────────────────────┤
│                    现有基础 (Current Foundation)             │
│  InteractiveMap / TimelineSystem / VisionSystem / A* Path   │
└─────────────────────────────────────────────────────────────┘
```

---

## 里程碑规划

### M0 - 基础设施 ✅ 已完成
> 地图渲染与基础交互

- [x] 地图底图（官方小地图 + 导航网格）
- [x] 滚轮缩放 + 中键拖拽
- [x] 实体渲染（树木/野怪营地/建筑/塔/神符）
- [x] A* 寻路算法（二叉堆优化 + 砍树联动）
- [x] 实体数据结构化

---

### M1 - 实体信息层 ✅ 已完成
> 图标展示 + 点击查看详情

- [x] 图标雪碧图系统（36 图标 + 颜色叠加）
- [x] 点击实体显示详情浮窗
- [x] 野怪营地类型标注（小/中/大/远古）
- [x] 防御塔/基地/前哨图标

---

### M2 - 时间轴系统 ✅ 已完成
> 引入时间维度，地图状态随时间变化

- [x] 时间轴控制器（0:00 ~ 60:00）
- [x] 播放/暂停 + 速度控制（1x/2x/4x）
- [x] 日夜循环（每 5 分钟切换）
- [x] 野怪清野状态

---

### M3 - 视野系统 ✅ 已完成
> 眼位模拟 + 战争迷雾

- [x] 眼位放置（真眼/假眼）
- [x] 视野圈渲染（高地遮挡 + 树木阻挡）
- [x] 日夜视野差异（白天 1600 / 夜间 800）
- [x] 战争迷雾（阵营切换）
- [x] 建筑视野（塔/基地）
- [x] 8 单位精确网格计算

详见：[ward-simulator-plan.md](./ward-simulator-plan.md)

---

### M4 - 单位系统 🔮 远期
> 统一的单位模型，支撑所有动态实体

**核心设计**：
```typescript
interface Unit {
  id: string
  type: 'hero' | 'creep' | 'neutral' | 'tower' | 'building' | 'boss'
  team: 'radiant' | 'dire' | 'neutral'
  position: { x: number, y: number }
  stats: UnitStats      // HP, 攻击, 护甲, 移速...
  state: UnitState      // alive, dead, respawning...
  movementSpeed: number
  visionRange: { day: number, night: number }
}
```

**功能清单**：
- [ ] Unit 基类定义
- [ ] 现有静态实体迁移（塔/野怪/建筑 → Unit）
- [ ] 小兵单位（固定路径行走 + 碰撞）
- [ ] 英雄单位（用户控制）
- [ ] 肉山 / 折磨者单位
- [ ] 单位属性面板

**数据需求**：
- `npc_units.txt`：单位基础属性
- 英雄数据（113+ 英雄）
- 兵线路径数据

---

### M5 - 路径规划增强 🔮 远期
> 从简单起点/终点升级为多点路径规划

**功能清单**：
- [ ] 多点路径（Waypoint 序列）
- [ ] 多条路径并存（不同颜色标识）
- [ ] 路径时间估算（距离 ÷ 移速）
- [ ] 路径与时间轴联动（何时出发/到达）
- [ ] 路径可编辑（拖拽调整节点）

**技术设计**：
```typescript
interface PathPlan {
  id: string
  unit: Unit
  waypoints: Waypoint[]
  startTime: number       // 时间轴起始时间
  color: string           // 路径颜色
}

interface Waypoint {
  position: { x: number, y: number }
  action?: Action         // 到达后执行的行动
  estimatedArrival: number
}
```

---

### M6 - 行动系统 🔮 远期
> 单位可执行的行为，与路径规划结合

**阶段规划**：

| 阶段 | 行动类型 | 说明 |
|------|----------|------|
| V1 | Move / Wait | 基础移动 |
| V2 | Attack | 攻击目标（计算 DPS × HP = 时间） |
| V3 | ChopTree / StackCamp | 砍树、堆野 |
| V4 | UseAbility / UseItem | 技能/物品（需大量数据） |

**技术设计**：
```typescript
interface Action {
  type: 'move' | 'attack' | 'wait' | 'chop_tree' | 'stack_camp' | ...
  target?: Unit | Position
  duration: number        // 计算出的耗时
}
```

**应用场景**：
- 刷野路径规划：英雄在各节点执行攻击行动，计算总刷野时间
- 拉野时机计算：根据野怪营地位置和刷新时间计算拉野节点

---

### M7 - 录像解析 🔮 远期
> 解析 Dota 2 .dem 录像文件

**功能清单**：
- [ ] .dem 文件解析（Source 2 Protobuf）
- [ ] 提取关键数据：
  - 单位位置（tick by tick）
  - 技能释放事件
  - 击杀/死亡事件
  - 物品购买
- [ ] 录像时间轴控制

**技术方案**：
- 可考虑使用 [clarity](https://github.com/skadistats/clarity) (Java) 或 [manta](https://github.com/dotabuff/manta) (Go)
- 预处理为 JSON 后供前端使用

---

### M8 - 沙盘推演 🔮 远期
> 录像暂停后进入模拟模式

**功能清单**：
- [ ] 从录像快照创建沙盘状态
- [ ] 用户规划单位行动
- [ ] 推演结果对比（原录像 vs 模拟）

---

## 风险与备选方案

| 风险 | 影响 | 备选方案 |
|------|------|----------|
| 单位系统复杂度高 | M4 实现周期长 | 先支持静态图标 + 详情，暂不模拟动态行为 |
| 技能/物品数据量大 | M6 V4 难实现 | 只支持基础攻击，不含技能 |
| .dem 解析复杂 | M7 可能失败 | 使用第三方服务预处理 |
| 战斗模拟不准确 | M8 体验差 | 简化为"路径模拟"，不含战斗 |

---

## 当前状态

| 里程碑 | 状态 | 详情 |
|--------|------|------|
| M0 基础设施 | ✅ 完成 | |
| M1 实体信息层 | ✅ 完成 | 详情浮窗可扩展 |
| M2 时间轴系统 | ✅ 完成 | |
| M3 视野系统 | ✅ 完成 | |
| M4 单位系统 | 🔮 远期 | 需要专项设计 |
| M5 路径规划增强 | 🔮 远期 | 依赖 M4 |
| M6 行动系统 | 🔮 远期 | 依赖 M4 + M5 |
| M7 录像解析 | 🔮 远期 | 高风险 |
| M8 沙盘推演 | 🔮 远期 | 最终愿景 |

---

## 相关文档

- [ward-simulator-plan.md](./ward-simulator-plan.md) - 眼位模拟器计划（M1 + M3 实现）
- [map-data-enhancement-plan.md](./map-data-enhancement-plan.md) - 近期数据分析任务
