# 眼位模拟器计划

> 基于交互式地图的眼位放置与视野可视化工具

---

## 目标

构建一个 **Dota 2 眼位模拟器**，支持：
1. 在地图上放置真眼/假眼
2. 实时显示视野覆盖范围
3. 考虑高地遮挡和日夜视野差异

---

## 功能清单

### Phase 1: 实体信息层 (M1) ✅ 完成

- [x] 点击实体显示详情浮窗
- [x] 野怪营地类型标注（小/中/大/远古）
- [x] 根据类型显示不同大小和颜色

### Phase 2: 地图完善 ✅ 完成

- [x] 图标雪碧图系统
  - [x] `icons-config.json` 36 个图标配置
  - [x] 颜色叠加渲染（tintColor + 缓存）
  - [x] 背景透明化处理
- [x] 野怪营地图标（小/中/大/远古）
- [x] 建筑图标（前哨/遗迹）
- [x] 防御塔图标（中路/边路）
- [x] 神符点图标

> [!NOTE]
> **待补充元素**（图标已配置，渲染逻辑待实现）：
> 肉山、神秘商店、基地商店、高地普通建筑、传送门、经验神龛、痛苦魔方、观察者（Tormentor）

### Phase 3: 时间轴系统 ✅ 完成

- [x] 右键菜单系统
  - [x] 野怪营地：清野/恢复
  - [x] 树木：砍树/恢复
  - [x] 空白区域：设为起点/终点/清除路径
- [x] 时间条控制（0:00 ~ 60:00）
  - [x] 播放/暂停按钮
  - [x] 时间滑块拖拽
  - [x] 速度选择（1x/2x/4x）
- [x] 日夜循环（每5分钟切换）
  - [x] 夜间蓝色遮罩效果
  - [x] 日夜图标指示器
- [x] 野怪清野状态
  - [x] 灰色半透明显示
  - [x] 已清营地计数

### Phase 4: 视野系统 ✅ 完成

#### 4.1 基础功能 ✅ 已完成
- [x] 眼位放置交互（真眼/假眼）
- [x] 视野圈渲染（考虑高地遮挡）
- [x] 日夜视野差异（白天1600/夜间800）
- [x] 多眼位视野叠加显示
- [x] 树木砍伐与视野联动
  - [x] 砍掉的树木位置可放置眼位
  - [x] 砍掉的树木不再阻挡视野
- [x] 8单位网格精确视线计算
- [x] 树木聚类（Union-Find 算法，2448棵逻辑树）

#### 4.2 战争迷雾与样式优化 ✅ 已完成
- [x] 战争迷雾渲染优化（使用 evenodd 填充）
- [x] 眼位视野显示样式
  - [x] 使用雪碧图图标（ward_observer/ward_sentry）替代 emoji
  - [x] 天辉眼位叠加绿色，夜魇叠加红色
- [x] 地图亮度优化
  - [x] 白天暖光、夜晚冷光叠加（overlay 混合模式）
  - [x] 移除旧的暗色夜间遮罩

#### 4.3 阵营区分 ✅ 已完成
- [x] 插眼功能区分天辉/夜魇
  - [x] 可切换当前操作阵营
  - [x] 不同阵营眼位使用不同颜色标识

#### 4.4 待完成功能
- [ ] **眼位选中 UX**
  - [x] 左键选中眼位时显示黄色视野圈
  - [x] 点击空白处取消选中
  - [ ] 选中后可拖动调整位置
- [ ] **阵营战争迷雾切换**
  - [ ] 可选择查看天辉/夜魇视角
- [x] 防御塔真视范围显示（点击塔显示700+144=844单位虚线圈）
- [x] 视野阻挡点（肉山坑区域）从 `ent_fow_blocker_node.png` 提取

### Phase 5: 数据加载优化 ✅ 完成

- [x] Python 预计算脚本 `generate_vision_data.py`
  - [x] 生成统一 `vision_data.json`（高度、树木、阻挡点）
- [x] JSON 数据加载替代图像解析
  - [x] 移除 `CanvasImageHandler` 类
  - [x] 使用 `fetch().json()` 直接加载
- [x] 树木聚类移至 Python 端
  - [x] 减少 90% 前端计算负载
- [x] 资源体积优化
  - [x] 分层网格 + 递归元组压缩
  - [x] 99MB → **2.29MB**

### Phase 6: 交互性能优化 ✅ 完成

- [x] **分层网格架构**
  - [x] 分析网格：64单位（~9万单元格）用于实时交互计算
  - [x] 渲染网格：8单位（2401×2401）用于高精度显示
- [x] 眼位拖拽流畅度
  - [x] 60FPS 流畅交互体验
  - [x] 移除 576 万次冗余 Grid 初始化循环
- [x] 懒加载高度墙壁（Lazy-cached elevation walls）
- [x] 假眼白天视野半径标准化为 1600 单位

### Phase 7: 视觉细节与专业功能 🔧 进行中

#### 已完成
- [x] 地图亮度校准
  - [x] 使用 Dota 2 官方小地图底图
  - [x] VPK 资源路径: `materials/overviews/dota_minimal_psd_f4e53729.vtex_c`
  - [x] 处理流程：裁剪黑边 (60-963) → 缩放到 2401x2401
- [x] 雪碧图图标过渡
  - [x] 使用 `ward_observer`/`ward_sentry` 替代 emoji
  - [x] 应用天辉（绿色）/夜魇（红色）着色
  - [x] 图标尺寸标准化为 1.0
- [x] 战争迷雾渲染优化
  - [x] GPU 加速 Path2D 蒙版（evenodd 规则）
- [x] 地图配色优化
  - [x] 底图纯灰色系（高度层次微差，避免垃华感）
  - [x] 战争迷雾反推配色（有视野区域更亮）
  - [x] 树木青绿色 `rgba(50, 160, 140, 0.8)` 与阵营绿区分
  - [x] 统一阵营颜色：天辉 `#32cd32` / 夜魇 `#dc143c`
- [x] 图标尺寸调整
  - [x] 防御塔按实际体积（144单位半径）显示
  - [x] 基地按约1000单位尺寸显示
  - [x] 野怪/神符图标最小尺寸限制（避免缩小时看不清）
- [x] 战争迷雾层级调整
  - [x] 迷雾只影响底图和树木，不影响图标
- [x] 阵营识别
  - [x] 添加 `team` 属性和阵营颜色编码
  - [x] 统一应用到防御塔、基地、眼位

#### 待完成
- [x] **眼位选中 UX** ✅ 已完成
  - [x] 选中眼位时显示视野圈和黄色高亮环
  - [x] 点击空白处隐藏详情
  - [x] 选中后可拖动调整位置（实时更新视野）
- [ ] **阵营可见性**
  - [ ] 实现天辉/夜魇专用战争迷雾切换
  - [ ] 添加阵营切换按钮（天辉/夜魇/双方）
- [x] **固定资产视野** ✅ 已完成
  - [x] 防御塔视野半径（T1: 日1900/夜600, T2+: 日1900/夜1100）
  - [x] 基地遗迹视野（日夜2600）
  - [x] 建筑视野缓存（日/夜分离）
- [x] **视野阻挡数据** ✅ 已完成
  - [x] 从 `ent_fow_blocker_node.png` 提取肉山坑区域阻挡点
  - [x] FOW 阻挡点调试图层（可切换显示）

#### 已修复问题
- [x] ~~打开地图时，战争迷雾没有显示~~ → 修改条件为 `combinedVision.size > 0`
- [x] ~~拖动地图时非常卡顿~~ → 添加迷雾离屏Canvas缓存
- [x] ~~某些区域视野被异常截断~~ → 修复高度阻挡逻辑（高地不阻止光线传播，只影响可见性）

#### 已知问题
- [ ] 阵营切换缺少"双方阵营"选项按钮

---

## 数据需求

| 数据 | 来源 | 状态 |
|------|------|------|
| elevation.png | dota-map-coordinates | ✅ 已有 |
| 野怪营地类型 | 手动标注 | ✅ 完成 |
| 传送门/莲花池等 | VPK 提取 | ⏳ 待提取 |
| Dota 图标 | 游戏资源 | ⏳ 待提取 |

---

## 进度跟踪

- [x] M0 基础设施
- [x] M1 实体信息层
- [x] Phase 2 地图完善
- [x] Phase 3 时间轴系统
- [x] Phase 4 视野系统 ✅ 完成（子网格精确 LoS & 动态树木联动）
- [x] Phase 5 数据加载优化 ✅ 完成（2.29MB 资源）
- [x] Phase 6 交互性能重构 ✅ 完成（60FPS 交互 & 像素级精度）
- [ ] Phase 7 视觉细节与专业功能 🔧 进行中（灯光和图标已完成）
